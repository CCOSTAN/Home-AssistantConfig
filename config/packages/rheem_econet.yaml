######################################################################
# @CCOSTAN - Follow Me on X
# For more info visit https://www.vcloudinfo.com/click-here
# Original Repo : https://github.com/CCOSTAN/Home-AssistantConfig
# -------------------------------------------------------------------
# Rheem EcoNet Water Heater - Monitoring and control
# Related Issue: 1550
#  Logs hot-water availability alerts to Activity feed; keeps announcements.
# -------------------------------------------------------------------
# Docs: https://www.home-assistant.io/integrations/econet/ | Existing notes: Issue #892
# Powerwall outage control for Rheem WH lives in config/packages/powerwall.yaml
######################################################################

##############################################################################
###  Automations
##############################################################################

automation:
  - alias: "Rheem Water Heater Health Monitoring"
    trigger:
      - platform: numeric_state
        entity_id: sensor.rheem_wh_compressor_health
        below: 90  # Adjust threshold as needed
      - platform: numeric_state
        entity_id: sensor.rheem_wh_tank_health
        below: 90  # Adjust threshold as needed
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: sensor.rheem_wh_compressor_health
            sequence:
              - service: script.notify_engine
                data:
                  title: "Maintenance Alert"
                  value1: "Rheem Water Tank Compressor Health below recommended level."
                  who: 'carlo'
                  group: 'information'
          - conditions:
              - condition: trigger
                id: sensor.rheem_wh_tank_health
            sequence:
              - service: script.notify_engine
                data:
                  title: "Maintenance Alert"
                  value1: "Rheem Water Tank Health below recommended level."
                  who: 'carlo'
                  group: 'information'

  - alias: "Rheem Water Heater Hot Water Availability Alert"
    trigger:
      - platform: numeric_state
        entity_id: sensor.rheem_wh_available_hot_water
        below: 30  # Alert when available hot water drops below 30%
    action:
      - service: script.send_to_logbook
        data:
          topic: "WATER"
          message: "Hot water availability is below 30%."
      - service: script.speech_engine
        data:
          value1: "Please be aware that the hot water has dropped below 30% availability. Gallons used today: {{sensor.phyn_daily_water_usage}}"

      - service: notify.alexa_media_master_bathroom
        data:
          message: "Please be aware that the hot water has dropped below 30% availability. Please wrap up your shower soon."
          data:
            type: announce

      - service: notify.alexa_media_upstairs
        data:
          message: "Please be aware that the hot water has dropped below 30% availability. Please wrap up your shower soon."
          data:
            type: announce

      - wait_template: "{{ states('sensor.rheem_wh_available_hot_water')|float > 50 }}"
        timeout: '01:00:00'  # Adjust timeout as needed
      - service: script.speech_engine
        data:
          value1: "The available hot water is now above 50%. Normal showering can resume. Gallons used today: {{sensor.phyn_daily_water_usage}}"

#-------------------------------------------
# Available Rheem entities snapshot (for reference)
# automation.rheem_water_heater_health_monitoring
# automation.rheem_water_heater_hot_water_availability_alert
# binary_sensor.rheem_wh_running
# binary_sensor.rheem_wh_shutoff_valve
# sensor.rheem_wh_alert_count
# sensor.rheem_wh_available_hot_water
# sensor.rheem_wh_compressor_health
# sensor.rheem_wh_override_status
# sensor.rheem_wh_power_usage_today
# sensor.rheem_wh_running_state
# sensor.rheem_wh_tank_health
# sensor.rheem_wh_water_usage_today
# sensor.rheem_wh_wifi_signal
# water_heater.rheem_wh


